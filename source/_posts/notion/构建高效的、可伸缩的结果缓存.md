---
categories:
  - ç®—æ³•ä¸æ•°æ®ç»“æ„
created_time: February 19, 2022 9:22 AM
date: 2020/07/10
excerpt: å‡ ä¹æ‰€æœ‰çš„æœåŠ¡å™¨åº”ç”¨ç¨‹åºéƒ½éœ€è¦ç¼“å†²ï¼Œæ¥æé«˜ç¨‹åºçš„ååé‡å’Œæ€§èƒ½ï¼Œä½†å´éœ€è¦æ¶ˆè€—æ›´å¤šçš„å†…å­˜ã€‚æœ¬æ–‡å°è¯•è‡ªå®šä¹‰ä¸€ä¸ªé«˜æ•ˆçš„ã€å¯ä¼¸ç¼©çš„ç»“æœç¼“å­˜ã€‚å¹¶è®°å½•ä¸‹æ„å»ºå’Œå­¦ä¹ çš„è¿‡ç¨‹ã€‚
show_category: Yes
status: å¾…å‘å¸ƒ
tags:
  - æ¶æ„
updated_time: February 19, 2022 10:41 AM
title: æ„å»ºé«˜æ•ˆçš„ã€å¯ä¼¸ç¼©çš„ç»“æœç¼“å­˜
---


<aside>

<img class="emoji" draggable="false" alt="ğŸ’¡" src="https://twemoji.maxcdn.com/v/13.1.0/72x72/1f4a1.png"/> å‡ ä¹æ‰€æœ‰çš„æœåŠ¡å™¨åº”ç”¨ç¨‹åºéƒ½éœ€è¦ç¼“å†²ï¼Œæ¥æé«˜ç¨‹åºçš„ååé‡å’Œæ€§èƒ½ï¼Œä½†å´éœ€è¦æ¶ˆè€—æ›´å¤šçš„å†…å­˜ã€‚æœ¬æ–‡å°è¯•è‡ªå®šä¹‰ä¸€ä¸ªé«˜æ•ˆçš„ã€å¯ä¼¸ç¼©çš„ç»“æœç¼“å­˜ã€‚å¹¶è®°å½•ä¸‹æ„å»ºå’Œå­¦ä¹ çš„è¿‡ç¨‹ã€‚
</aside>

### **æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨HashMapæ¥æ„å»ºç»“æœç¼“å­˜**

ä½¿ç”¨HashMapæ¥å­˜å‚¨æ•°æ®ï¼Œç”±äºHashMapä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œéœ€è¦åœ¨computeæ–¹æ³•ä¸ŠåŠ é”ï¼Œæ¥ä¿è¯æ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ç¼“å­˜ã€‚

```java
Â public interface Computable<A, V> {
Â     V compute(A arg) throws InterruptedException;
Â }
```

```java
Â public class Cacher1<A, V> implements Computable<A, V>{
Â     private final Map<A, V> cache = new HashMap<>();
Â     private final Computable<A, V> computable;
Â 
Â     public Cacher1(Computable<A, V> computable) {
Â         this.computable = computable;
Â     }
Â 
Â     @Override
Â     public synchronized V compute(A arg) throws InterruptedException {
Â         V value = cache.get(arg);
Â         if (value == null) {
Â             value = computable.compute(arg);
Â             cache.put(arg, value);
Â         }
Â         return value;
Â     }
Â }
```

æœ¬æ–¹æ¡ˆæš´éœ²å‡ºæ¥çš„é—®é¢˜æ˜¯æ€§èƒ½ä½ï¼Œå®¹æ˜“é˜»å¡å¤§é‡çº¿ç¨‹ã€‚

### **æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ConcurrentHashMapæ¥æ„å»ºç»“æœç¼“å­˜**

ä½¿ç”¨JDKæä¾›çš„`HashMap`çš„åŒæ­¥å®ç°ç±»`ConcurrentHashMap`æ¥æå‡ç¼“å­˜çš„å¹¶å‘æ€§ã€‚

```java
Â public class Cacher2<A, V> implements Computable<A, V>{
Â     private final Map<A, V> cache = new ConcurrentHashMap<>();
Â     private final Computable<A, V> computable;
Â 
Â     public Cacher2(Computable<A, V> computable) {
Â         this.computable = computable;
Â     }
Â 
Â     @Override
Â     public V compute(A arg) throws InterruptedException {
Â         V value = cache.get(arg);
Â         if (value == null) {
Â             value = computable.compute(arg);
Â             cache.put(arg, value);
Â         }
Â         return value;
Â     }
Â }
```

ç›¸å¯¹äºç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œå¹¶å‘æ€§èƒ½èƒ½å¾—åˆ°æ˜æ˜¾çš„æå‡ï¼Œä½†æ˜¯ä¼šé€ æˆé‡å¤è®¡ç®—ç›¸åŒçš„ç»“æœï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è·å–åŒä¸€ä¸ªç»“æœçš„æ—¶å€™ï¼Œéƒ½è¿›å…¥è€—æ—¶è®¡ç®—è¿‡ç¨‹ï¼Œè®¡ç®—å‡ºç›¸åŒçš„ç»“æœï¼Œå¢åŠ äº†æ²¡å¿…è¦çš„è®¡ç®—è´Ÿæ‹…ã€‚

### **æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨FutureTaskå¼‚æ­¥è¿›è¡Œè€—æ—¶è¿ç®—**

`FutureTask`å®ç°äº†`Future`æ¥å£ï¼Œè¡¨ç¤ºä¸€ç§æŠ½è±¡çš„ï¼Œå¯ç”Ÿæˆç»“æœçš„è®¡ç®—ã€‚`FutureTask`è¡¨ç¤ºçš„è®¡ç®—æ˜¯é€šè¿‡Callableæ¥å®ç°çš„ï¼Œç›¸å½“äºä¸€ç§å¯ç”Ÿæˆç»“æœçš„Runnableã€‚ä½¿ç”¨`FutureTask`å¼‚æ­¥è¿›è¡Œè€—æ—¶è¿ç®—ï¼Œ ç¼“å­˜é‡‡ç”¨å…ˆç¼“å­˜å†è®¡ç®—çš„æ–¹å¼ã€‚

```java
Â public class Cacher3<A, V> implements Computable<A, V>{
Â     private final Map<A, Future<V>> cache = new ConcurrentHashMap<>();
Â     private final Computable<A, V> computable;

Â     public Cacher3(Computable<A, V> computable) {
Â         this.computable = computable;
Â     }
Â 
Â     @Override
Â     public V compute(final A arg) throws InterruptedException {
Â         Future<V> future = cache.get(arg);
Â         if (future == null) {
Â             Callable<V> callable = new Callable<V>() {
Â                 @Override
Â                 public V call() throws InterruptedException {
Â                     return computable.compute(arg);
Â                 }
Â             };
Â             FutureTask<V> ft = new FutureTask<>(callable);
Â             future = ft;
Â             cache.put(arg, future);
Â             ft.run();
Â         }
Â         try {
Â             return future.get();
Â         } catch (ExecutionException e) {
Â             throw new InterruptedException(e.getMessage());
Â         }
Â     }

Â }
```

è¿˜æ˜¯ä¼šé€ æˆé‡å¤è®¡ç®—ç›¸åŒçš„ç»“æœï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è·å–åŒä¸€ä¸ªç»“æœçš„æ—¶å€™ï¼Œéƒ½è¿›å…¥è€—æ—¶è®¡ç®—è¿‡ç¨‹ï¼Œè®¡ç®—å‡ºç›¸åŒçš„ç»“æœï¼Œå¢åŠ äº†æ²¡å¿…è¦çš„è®¡ç®—è´Ÿæ‹…ã€‚

### **æ–¹æ¡ˆå››ï¼šCacherçš„æœ€ç»ˆå®ç°**

ä½¿ç”¨`ConcurrentHashMap`çš„`putIfAbsent`åŸå­çš„è¿›è¡Œç¼“å­˜ï¼Œæ¥è§£å†³é‡å¤è®¡ç®—çš„é—®é¢˜ã€‚

```java
Â public class Cacher<A, V> implements Computable<A, V>{
Â     private final ConcurrentMap<A, Future<V>> cache = new ConcurrentHashMap<>();
Â     private final Computable<A, V> computable;
Â 
Â     public Cacher(Computable<A, V> computable) {
Â         this.computable = computable;
Â     }
Â 
Â     @Override
Â     public V compute(final A arg) throws InterruptedException {
Â         Future<V> future = cache.get(arg);
Â         if (future == null) {
Â             Callable<V> callable = new Callable<V>() {
Â                 @Override
Â                 public V call() throws InterruptedException {
Â                     return computable.compute(arg);
Â                 }
Â             };
Â             FutureTask<V> ft = new FutureTask<>(callable);
Â             future = ft;
Â             cache.putIfAbsent(arg, future);
Â             ft.run();
Â         }
Â         try {
Â             return future.get();
Â         } catch (ExecutionException e) {
Â             throw new InterruptedException(e.getMessage());
Â         }
Â     }

Â }
```

æ­¤ç¼“å­˜æ²¡æœ‰å¯¹ç¼“å­˜çš„è¿‡æœŸåšå¤„ç†ã€‚

### **å…³äºå¹¶å‘ç¼–ç¨‹çš„æ€»ç»“ï¼š**

- å¯å˜çŠ¶æ€æ˜¯æŒ‡ç¯é‡è¦çš„ã€‚
- å°½é‡å°†åŸŸå£°æ˜ä¸ºfinalç±»å‹ï¼Œé™¤ééœ€è¦å®ƒä»¬æ˜¯å¯å˜çš„ã€‚
- ä¸å¯å˜å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
- å°è£…æœ‰åŠ©äºç®¡ç†å¤æ‚æ€§ã€‚
- ç”¨é”æ¥ä¿æŠ¤æ¯ä¸ªå¯å˜å˜é‡ã€‚
- å½“ä¿æŠ¤åŒä¸€ä¸ªä¸å˜æ€§æ¡ä»¶ä¸­çš„æ‰€æœ‰å˜é‡æ—¶ï¼Œè¦ä½¿ç”¨åŒä¸€ä¸ªé”ã€‚
- åœ¨æ‰§è¡Œå¤åˆæ“ä½œæœŸé—´ï¼Œè¦æŒæœ‰é”ã€‚
- å¦‚æœä»å¤šä¸ªçº¿ç¨‹ä¸­è®¿é—®åŒä¸€ä¸ªå¯å˜å˜é‡æ—¶æ²¡æœ‰åŒæ­¥æœºåˆ¶ï¼Œé‚£ä¹ˆç¨‹åºä¼šå‡ºç°é—®é¢˜ã€‚
- ä¸è¦æ•…ä½œèªæ˜çš„æ¨æ–­å‡ºä¸éœ€è¦ä½¿ç”¨åŒæ­¥ã€‚
- åœ¨è®¾è®¡è¿‡ç¨‹ä¸­è€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼Œæˆ–è€…åœ¨æ–‡æ¡£ä¸­æ˜ç¡®çš„æŒ‡å‡ºå®ƒä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
- å°†åŒæ­¥ç­–ç•¥æ–‡æ¡£åŒ–ã€‚